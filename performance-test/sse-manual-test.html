<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDOBANG SSE 수동 테스트</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #log { height: 300px; overflow-y: scroll; background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; white-space: pre-wrap; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .stat-item { text-align: center; padding: 10px; background: #e9ecef; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>🔔 DDOBANG SSE 실시간 알림 테스트</h1>
    
    <div class="container info">
        <h3>📋 테스트 가이드</h3>
        <p>1. 백엔드 서버가 실행 중인지 확인 (http://localhost:8080)</p>
        <p>2. JWT 토큰 발급 후 SSE 연결 테스트</p>
        <p>3. 알림 생성 및 실시간 수신 확인</p>
        <p>4. 연결 안정성 및 재연결 기능 테스트</p>
    </div>

    <div class="container">
        <h3>🔐 인증 설정</h3>
        <input type="text" id="authToken" placeholder="JWT 토큰 입력 (또는 자동 생성)" style="width: 400px;">
        <button onclick="generateTestToken()">테스트 토큰 생성</button>
        <button onclick="clearToken()">토큰 클리어</button>
    </div>

    <div class="container">
        <h3>🔌 SSE 연결 관리</h3>
        <button id="connectBtn" onclick="connectSSE()">SSE 연결</button>
        <button id="disconnectBtn" onclick="disconnectSSE()" disabled>연결 종료</button>
        <button onclick="reconnectSSE()">재연결</button>
        
        <div class="stats">
            <div class="stat-item">
                <div>연결 상태</div>
                <div id="connectionStatus">❌ 연결 끊김</div>
            </div>
            <div class="stat-item">
                <div>수신 메시지</div>
                <div id="messageCount">0</div>
            </div>
            <div class="stat-item">
                <div>연결 시간</div>
                <div id="connectionTime">-</div>
            </div>
            <div class="stat-item">
                <div>마지막 수신</div>
                <div id="lastReceived">-</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h3>📨 알림 테스트</h3>
        <input type="text" id="alarmTitle" placeholder="알림 제목" value="테스트 알림">
        <input type="text" id="alarmContent" placeholder="알림 내용" value="SSE 수동 테스트 알림입니다">
        
        <select id="alarmType">
            <option value="MESSAGE">메시지</option>
            <option value="PARTY_APPLY">파티 신청</option>
            <option value="PARTY_STATUS">파티 상태 변경</option>
            <option value="SUBSCRIBE">구독 알림</option>
            <option value="POST_REPLY">게시글 답글</option>
        </select>
        
        <button onclick="sendTestAlarm()">알림 생성 및 전송</button>
        <button onclick="sendMultipleAlarms()">연속 알림 (5개)</button>
    </div>

    <div class="container">
        <h3>🧪 성능 테스트</h3>
        <input type="number" id="stressCount" placeholder="알림 개수" value="10" min="1" max="100">
        <input type="number" id="stressInterval" placeholder="간격(ms)" value="100" min="10">
        <button onclick="startStressTest()">스트레스 테스트 시작</button>
        <button onclick="stopStressTest()">중지</button>
        
        <div id="stressResults" style="margin-top: 10px; font-family: monospace; font-size: 12px;"></div>
    </div>

    <div class="container">
        <h3>📊 실시간 로그</h3>
        <button onclick="clearLog()">로그 클리어</button>
        <button onclick="downloadLog()">로그 다운로드</button>
        <div id="log"></div>
    </div>

    <script>
        let eventSource = null;
        let messageCount = 0;
        let connectionStartTime = null;
        let stressTestInterval = null;
        let logEntries = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logEntries.push(logMessage);
            
            const logElement = document.getElementById('log');
            logElement.textContent += logMessage + '\n';
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logMessage);
        }

        function updateConnectionStatus(status, color) {
            document.getElementById('connectionStatus').innerHTML = `${color === 'green' ? '✅' : '❌'} ${status}`;
        }

        function updateStats() {
            document.getElementById('messageCount').textContent = messageCount;
            
            if (connectionStartTime) {
                const elapsed = Math.floor((Date.now() - connectionStartTime) / 1000);
                document.getElementById('connectionTime').textContent = `${elapsed}초`;
            }
        }

        async function generateTestToken() {
            try {
                log('테스트 토큰 생성 중...');
                const response = await fetch('http://localhost:8081/api/v1/test/jwt', {
                    method: 'GET',
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('authToken').value = data.token;
                    log('✅ 테스트 토큰 생성 완료');
                } else {
                    log('❌ 토큰 생성 실패: ' + response.status);
                }
            } catch (error) {
                log('❌ 토큰 생성 오류: ' + error.message);
            }
        }

        function clearToken() {
            document.getElementById('authToken').value = '';
            log('토큰 클리어됨');
        }

        function connectSSE() {
            const token = document.getElementById('authToken').value;
            if (!token) {
                alert('JWT 토큰을 먼저 생성하거나 입력하세요.');
                return;
            }

            if (eventSource) {
                eventSource.close();
            }

            log('SSE 연결 시도 중...');
            
            eventSource = new EventSource(`http://localhost:8081/api/v1/alarms/subscribe`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            eventSource.onopen = function(event) {
                log('✅ SSE 연결 성공!');
                updateConnectionStatus('연결됨', 'green');
                connectionStartTime = Date.now();
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
            };

            eventSource.onmessage = function(event) {
                messageCount++;
                document.getElementById('lastReceived').textContent = new Date().toLocaleTimeString();
                log(`📨 메시지 수신: ${event.data}`);
                updateStats();
            };

            // 특정 이벤트 타입 처리
            eventSource.addEventListener('connect', function(event) {
                log(`🔌 연결 이벤트: ${event.data}`);
            });

            eventSource.addEventListener('alarm', function(event) {
                const alarmData = JSON.parse(event.data);
                log(`🔔 알림 수신: ${alarmData.title} - ${alarmData.content}`);
                
                // 브라우저 알림 표시 (권한 있을 때)
                if (Notification.permission === 'granted') {
                    new Notification(alarmData.title, {
                        body: alarmData.content,
                        icon: '/favicon.ico'
                    });
                }
            });

            eventSource.onerror = function(event) {
                log('❌ SSE 연결 오류 발생');
                updateConnectionStatus('연결 오류', 'red');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            };

            eventSource.onclose = function(event) {
                log('🔌 SSE 연결 종료됨');
                updateConnectionStatus('연결 끊김', 'red');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            };
        }

        function disconnectSSE() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                log('🔌 SSE 연결 수동 종료');
                updateConnectionStatus('연결 끊김', 'red');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            }
        }

        function reconnectSSE() {
            log('🔄 SSE 재연결 시도...');
            disconnectSSE();
            setTimeout(connectSSE, 1000);
        }

        async function sendTestAlarm() {
            const token = document.getElementById('authToken').value;
            if (!token) {
                alert('JWT 토큰이 필요합니다.');
                return;
            }

            const alarmData = {
                receiverId: 1, // 테스트 사용자 ID
                title: document.getElementById('alarmTitle').value,
                content: document.getElementById('alarmContent').value,
                alarmType: document.getElementById('alarmType').value,
                relId: Math.floor(Math.random() * 1000)
            };

            try {
                log('📤 알림 생성 요청 중...');
                const response = await fetch('http://localhost:8081/api/v1/alarms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(alarmData)
                });

                if (response.ok) {
                    const result = await response.json();
                    log('✅ 알림 생성 성공: ' + result.data.title);
                } else {
                    log('❌ 알림 생성 실패: ' + response.status);
                }
            } catch (error) {
                log('❌ 알림 생성 오류: ' + error.message);
            }
        }

        async function sendMultipleAlarms() {
            log('📤 연속 알림 전송 시작...');
            for (let i = 1; i <= 5; i++) {
                document.getElementById('alarmTitle').value = `연속 테스트 알림 ${i}`;
                await sendTestAlarm();
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            log('✅ 연속 알림 전송 완료');
        }

        function startStressTest() {
            const count = parseInt(document.getElementById('stressCount').value);
            const interval = parseInt(document.getElementById('stressInterval').value);
            
            log(`🧪 스트레스 테스트 시작: ${count}개 알림, ${interval}ms 간격`);
            
            let sentCount = 0;
            const startTime = Date.now();
            
            stressTestInterval = setInterval(async () => {
                if (sentCount >= count) {
                    stopStressTest();
                    const totalTime = Date.now() - startTime;
                    const results = `스트레스 테스트 완료\n총 시간: ${totalTime}ms\n평균: ${totalTime/count}ms/알림\nTPS: ${(count * 1000 / totalTime).toFixed(2)}`;
                    document.getElementById('stressResults').textContent = results;
                    log('✅ ' + results.replace(/\n/g, ', '));
                    return;
                }
                
                document.getElementById('alarmTitle').value = `스트레스 테스트 ${sentCount + 1}`;
                document.getElementById('alarmContent').value = `성능 테스트 알림 ${sentCount + 1}/${count}`;
                await sendTestAlarm();
                sentCount++;
            }, interval);
        }

        function stopStressTest() {
            if (stressTestInterval) {
                clearInterval(stressTestInterval);
                stressTestInterval = null;
                log('🛑 스트레스 테스트 중지');
            }
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
            logEntries = [];
            messageCount = 0;
            updateStats();
        }

        function downloadLog() {
            const logText = logEntries.join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sse-test-log-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 페이지 로드 시 브라우저 알림 권한 요청
        if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
            Notification.requestPermission();
        }

        // 주기적으로 통계 업데이트
        setInterval(updateStats, 1000);

        log('🚀 SSE 테스트 페이지 로드 완료');
    </script>
</body>
</html>