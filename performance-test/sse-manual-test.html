<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDOBANG SSE ìˆ˜ë™ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #log { height: 300px; overflow-y: scroll; background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; white-space: pre-wrap; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .stat-item { text-align: center; padding: 10px; background: #e9ecef; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ”” DDOBANG SSE ì‹¤ì‹œê°„ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</h1>
    
    <div class="container info">
        <h3>ğŸ“‹ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ</h3>
        <p>1. ë°±ì—”ë“œ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸ (http://localhost:8080)</p>
        <p>2. JWT í† í° ë°œê¸‰ í›„ SSE ì—°ê²° í…ŒìŠ¤íŠ¸</p>
        <p>3. ì•Œë¦¼ ìƒì„± ë° ì‹¤ì‹œê°„ ìˆ˜ì‹  í™•ì¸</p>
        <p>4. ì—°ê²° ì•ˆì •ì„± ë° ì¬ì—°ê²° ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</p>
    </div>

    <div class="container">
        <h3>ğŸ” ì¸ì¦ ì„¤ì •</h3>
        <input type="text" id="authToken" placeholder="JWT í† í° ì…ë ¥ (ë˜ëŠ” ìë™ ìƒì„±)" style="width: 400px;">
        <button onclick="generateTestToken()">í…ŒìŠ¤íŠ¸ í† í° ìƒì„±</button>
        <button onclick="clearToken()">í† í° í´ë¦¬ì–´</button>
    </div>

    <div class="container">
        <h3>ğŸ”Œ SSE ì—°ê²° ê´€ë¦¬</h3>
        <button id="connectBtn" onclick="connectSSE()">SSE ì—°ê²°</button>
        <button id="disconnectBtn" onclick="disconnectSSE()" disabled>ì—°ê²° ì¢…ë£Œ</button>
        <button onclick="reconnectSSE()">ì¬ì—°ê²°</button>
        
        <div class="stats">
            <div class="stat-item">
                <div>ì—°ê²° ìƒíƒœ</div>
                <div id="connectionStatus">âŒ ì—°ê²° ëŠê¹€</div>
            </div>
            <div class="stat-item">
                <div>ìˆ˜ì‹  ë©”ì‹œì§€</div>
                <div id="messageCount">0</div>
            </div>
            <div class="stat-item">
                <div>ì—°ê²° ì‹œê°„</div>
                <div id="connectionTime">-</div>
            </div>
            <div class="stat-item">
                <div>ë§ˆì§€ë§‰ ìˆ˜ì‹ </div>
                <div id="lastReceived">-</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h3>ğŸ“¨ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</h3>
        <input type="text" id="alarmTitle" placeholder="ì•Œë¦¼ ì œëª©" value="í…ŒìŠ¤íŠ¸ ì•Œë¦¼">
        <input type="text" id="alarmContent" placeholder="ì•Œë¦¼ ë‚´ìš©" value="SSE ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì…ë‹ˆë‹¤">
        
        <select id="alarmType">
            <option value="MESSAGE">ë©”ì‹œì§€</option>
            <option value="PARTY_APPLY">íŒŒí‹° ì‹ ì²­</option>
            <option value="PARTY_STATUS">íŒŒí‹° ìƒíƒœ ë³€ê²½</option>
            <option value="SUBSCRIBE">êµ¬ë… ì•Œë¦¼</option>
            <option value="POST_REPLY">ê²Œì‹œê¸€ ë‹µê¸€</option>
        </select>
        
        <button onclick="sendTestAlarm()">ì•Œë¦¼ ìƒì„± ë° ì „ì†¡</button>
        <button onclick="sendMultipleAlarms()">ì—°ì† ì•Œë¦¼ (5ê°œ)</button>
    </div>

    <div class="container">
        <h3>ğŸ§ª ì„±ëŠ¥ í…ŒìŠ¤íŠ¸</h3>
        <input type="number" id="stressCount" placeholder="ì•Œë¦¼ ê°œìˆ˜" value="10" min="1" max="100">
        <input type="number" id="stressInterval" placeholder="ê°„ê²©(ms)" value="100" min="10">
        <button onclick="startStressTest()">ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
        <button onclick="stopStressTest()">ì¤‘ì§€</button>
        
        <div id="stressResults" style="margin-top: 10px; font-family: monospace; font-size: 12px;"></div>
    </div>

    <div class="container">
        <h3>ğŸ“Š ì‹¤ì‹œê°„ ë¡œê·¸</h3>
        <button onclick="clearLog()">ë¡œê·¸ í´ë¦¬ì–´</button>
        <button onclick="downloadLog()">ë¡œê·¸ ë‹¤ìš´ë¡œë“œ</button>
        <div id="log"></div>
    </div>

    <script>
        let eventSource = null;
        let messageCount = 0;
        let connectionStartTime = null;
        let stressTestInterval = null;
        let logEntries = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logEntries.push(logMessage);
            
            const logElement = document.getElementById('log');
            logElement.textContent += logMessage + '\n';
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logMessage);
        }

        function updateConnectionStatus(status, color) {
            document.getElementById('connectionStatus').innerHTML = `${color === 'green' ? 'âœ…' : 'âŒ'} ${status}`;
        }

        function updateStats() {
            document.getElementById('messageCount').textContent = messageCount;
            
            if (connectionStartTime) {
                const elapsed = Math.floor((Date.now() - connectionStartTime) / 1000);
                document.getElementById('connectionTime').textContent = `${elapsed}ì´ˆ`;
            }
        }

        async function generateTestToken() {
            try {
                log('í…ŒìŠ¤íŠ¸ í† í° ìƒì„± ì¤‘...');
                const response = await fetch('http://localhost:8081/api/v1/test/jwt', {
                    method: 'GET',
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('authToken').value = data.token;
                    log('âœ… í…ŒìŠ¤íŠ¸ í† í° ìƒì„± ì™„ë£Œ');
                } else {
                    log('âŒ í† í° ìƒì„± ì‹¤íŒ¨: ' + response.status);
                }
            } catch (error) {
                log('âŒ í† í° ìƒì„± ì˜¤ë¥˜: ' + error.message);
            }
        }

        function clearToken() {
            document.getElementById('authToken').value = '';
            log('í† í° í´ë¦¬ì–´ë¨');
        }

        function connectSSE() {
            const token = document.getElementById('authToken').value;
            if (!token) {
                alert('JWT í† í°ì„ ë¨¼ì € ìƒì„±í•˜ê±°ë‚˜ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            if (eventSource) {
                eventSource.close();
            }

            log('SSE ì—°ê²° ì‹œë„ ì¤‘...');
            
            eventSource = new EventSource(`http://localhost:8081/api/v1/alarms/subscribe`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            eventSource.onopen = function(event) {
                log('âœ… SSE ì—°ê²° ì„±ê³µ!');
                updateConnectionStatus('ì—°ê²°ë¨', 'green');
                connectionStartTime = Date.now();
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
            };

            eventSource.onmessage = function(event) {
                messageCount++;
                document.getElementById('lastReceived').textContent = new Date().toLocaleTimeString();
                log(`ğŸ“¨ ë©”ì‹œì§€ ìˆ˜ì‹ : ${event.data}`);
                updateStats();
            };

            // íŠ¹ì • ì´ë²¤íŠ¸ íƒ€ì… ì²˜ë¦¬
            eventSource.addEventListener('connect', function(event) {
                log(`ğŸ”Œ ì—°ê²° ì´ë²¤íŠ¸: ${event.data}`);
            });

            eventSource.addEventListener('alarm', function(event) {
                const alarmData = JSON.parse(event.data);
                log(`ğŸ”” ì•Œë¦¼ ìˆ˜ì‹ : ${alarmData.title} - ${alarmData.content}`);
                
                // ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ (ê¶Œí•œ ìˆì„ ë•Œ)
                if (Notification.permission === 'granted') {
                    new Notification(alarmData.title, {
                        body: alarmData.content,
                        icon: '/favicon.ico'
                    });
                }
            });

            eventSource.onerror = function(event) {
                log('âŒ SSE ì—°ê²° ì˜¤ë¥˜ ë°œìƒ');
                updateConnectionStatus('ì—°ê²° ì˜¤ë¥˜', 'red');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            };

            eventSource.onclose = function(event) {
                log('ğŸ”Œ SSE ì—°ê²° ì¢…ë£Œë¨');
                updateConnectionStatus('ì—°ê²° ëŠê¹€', 'red');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            };
        }

        function disconnectSSE() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                log('ğŸ”Œ SSE ì—°ê²° ìˆ˜ë™ ì¢…ë£Œ');
                updateConnectionStatus('ì—°ê²° ëŠê¹€', 'red');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            }
        }

        function reconnectSSE() {
            log('ğŸ”„ SSE ì¬ì—°ê²° ì‹œë„...');
            disconnectSSE();
            setTimeout(connectSSE, 1000);
        }

        async function sendTestAlarm() {
            const token = document.getElementById('authToken').value;
            if (!token) {
                alert('JWT í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            const alarmData = {
                receiverId: 1, // í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ID
                title: document.getElementById('alarmTitle').value,
                content: document.getElementById('alarmContent').value,
                alarmType: document.getElementById('alarmType').value,
                relId: Math.floor(Math.random() * 1000)
            };

            try {
                log('ğŸ“¤ ì•Œë¦¼ ìƒì„± ìš”ì²­ ì¤‘...');
                const response = await fetch('http://localhost:8081/api/v1/alarms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(alarmData)
                });

                if (response.ok) {
                    const result = await response.json();
                    log('âœ… ì•Œë¦¼ ìƒì„± ì„±ê³µ: ' + result.data.title);
                } else {
                    log('âŒ ì•Œë¦¼ ìƒì„± ì‹¤íŒ¨: ' + response.status);
                }
            } catch (error) {
                log('âŒ ì•Œë¦¼ ìƒì„± ì˜¤ë¥˜: ' + error.message);
            }
        }

        async function sendMultipleAlarms() {
            log('ğŸ“¤ ì—°ì† ì•Œë¦¼ ì „ì†¡ ì‹œì‘...');
            for (let i = 1; i <= 5; i++) {
                document.getElementById('alarmTitle').value = `ì—°ì† í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ${i}`;
                await sendTestAlarm();
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            log('âœ… ì—°ì† ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ');
        }

        function startStressTest() {
            const count = parseInt(document.getElementById('stressCount').value);
            const interval = parseInt(document.getElementById('stressInterval').value);
            
            log(`ğŸ§ª ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ì‹œì‘: ${count}ê°œ ì•Œë¦¼, ${interval}ms ê°„ê²©`);
            
            let sentCount = 0;
            const startTime = Date.now();
            
            stressTestInterval = setInterval(async () => {
                if (sentCount >= count) {
                    stopStressTest();
                    const totalTime = Date.now() - startTime;
                    const results = `ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ì™„ë£Œ\nì´ ì‹œê°„: ${totalTime}ms\ní‰ê· : ${totalTime/count}ms/ì•Œë¦¼\nTPS: ${(count * 1000 / totalTime).toFixed(2)}`;
                    document.getElementById('stressResults').textContent = results;
                    log('âœ… ' + results.replace(/\n/g, ', '));
                    return;
                }
                
                document.getElementById('alarmTitle').value = `ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ${sentCount + 1}`;
                document.getElementById('alarmContent').value = `ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ${sentCount + 1}/${count}`;
                await sendTestAlarm();
                sentCount++;
            }, interval);
        }

        function stopStressTest() {
            if (stressTestInterval) {
                clearInterval(stressTestInterval);
                stressTestInterval = null;
                log('ğŸ›‘ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ì¤‘ì§€');
            }
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
            logEntries = [];
            messageCount = 0;
            updateStats();
        }

        function downloadLog() {
            const logText = logEntries.join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sse-test-log-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
        if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
            Notification.requestPermission();
        }

        // ì£¼ê¸°ì ìœ¼ë¡œ í†µê³„ ì—…ë°ì´íŠ¸
        setInterval(updateStats, 1000);

        log('ğŸš€ SSE í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
    </script>
</body>
</html>