<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDOBANG SSE + RabbitMQ 테스트</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; }
        .connected { color: green; }
        .error { color: red; }
        .message { color: blue; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 DDOBANG 하이브리드 알림 시스템 테스트</h1>
        
        <!-- 연결 상태 -->
        <div class="section">
            <h3>📡 SSE 연결 상태</h3>
            <p>상태: <span id="connectionStatus">연결 해제</span></p>
            <button onclick="connectSSE()">SSE 연결</button>
            <button onclick="disconnectSSE()">연결 해제</button>
        </div>

        <!-- JWT 토큰 -->
        <div class="section">
            <h3>🔐 JWT 인증</h3>
            <button onclick="getToken()">JWT 토큰 생성</button>
            <p>토큰: <span id="tokenStatus">없음</span></p>
        </div>

        <!-- 알림 테스트 -->
        <div class="section">
            <h3>🔔 알림 테스트</h3>
            <button onclick="createParty()">파티 생성 (알림 발생)</button>
            <button onclick="sendMessage()">메시지 전송 (알림 발생)</button>
            <button onclick="checkSystemStatus()">시스템 상태 확인</button>
        </div>

        <!-- 로그 -->
        <div class="section">
            <h3>📝 실시간 로그</h3>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">로그 지우기</button>
        </div>
    </div>

    <script>
        let eventSource = null;
        let jwtToken = null;
        const BASE_URL = 'http://localhost:8080';

        // 로그 추가
        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'connected' : 'message';
            log.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        // JWT 토큰 생성
        async function getToken() {
            try {
                const response = await fetch(`${BASE_URL}/api/v1/test/auth/token`);
                const data = await response.json();
                
                if (data.success) {
                    jwtToken = data.data.accessToken;
                    document.getElementById('tokenStatus').textContent = '생성됨';
                    addLog('JWT 토큰 생성 성공', 'success');
                } else {
                    addLog('JWT 토큰 생성 실패', 'error');
                }
            } catch (error) {
                addLog(`토큰 생성 오류: ${error.message}`, 'error');
            }
        }

        // SSE 연결
        function connectSSE() {
            if (!jwtToken) {
                addLog('JWT 토큰이 필요합니다. 먼저 토큰을 생성하세요.', 'error');
                return;
            }

            if (eventSource) {
                eventSource.close();
            }

            const url = `${BASE_URL}/api/v1/alarms/subscribe`;
            eventSource = new EventSource(url + `?token=${jwtToken}`);

            eventSource.onopen = function() {
                document.getElementById('connectionStatus').textContent = '연결됨';
                document.getElementById('connectionStatus').className = 'connected';
                addLog('SSE 연결 성공', 'success');
            };

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                addLog(`알림 수신: ${data.title} - ${data.content}`, 'message');
            };

            eventSource.onerror = function(event) {
                document.getElementById('connectionStatus').textContent = '연결 오류';
                document.getElementById('connectionStatus').className = 'error';
                addLog('SSE 연결 오류', 'error');
            };
        }

        // SSE 연결 해제
        function disconnectSSE() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            document.getElementById('connectionStatus').textContent = '연결 해제';
            document.getElementById('connectionStatus').className = '';
            addLog('SSE 연결 해제');
        }

        // 파티 생성 (알림 발생)
        async function createParty() {
            if (!jwtToken) {
                addLog('JWT 토큰이 필요합니다.', 'error');
                return;
            }

            const partyData = {
                title: `테스트 파티 ${new Date().getTime()}`,
                content: '하이브리드 알림 테스트용 파티',
                maxPeople: 4,
                scheduledAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                themeId: 1,
                storeId: 1
            };

            try {
                const response = await fetch(`${BASE_URL}/api/v1/parties`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(partyData)
                });

                if (response.ok) {
                    addLog('파티 생성 성공 - 알림 발생 예상', 'success');
                } else {
                    addLog(`파티 생성 실패: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`파티 생성 오류: ${error.message}`, 'error');
            }
        }

        // 메시지 전송 (알림 발생)
        async function sendMessage() {
            if (!jwtToken) {
                addLog('JWT 토큰이 필요합니다.', 'error');
                return;
            }

            const messageData = {
                content: `테스트 메시지 ${new Date().getTime()}`,
                receiverId: 1
            };

            try {
                const response = await fetch(`${BASE_URL}/api/v1/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messageData)
                });

                if (response.ok) {
                    addLog('메시지 전송 성공 - 알림 발생 예상', 'success');
                } else {
                    addLog(`메시지 전송 실패: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`메시지 전송 오류: ${error.message}`, 'error');
            }
        }

        // 시스템 상태 확인
        async function checkSystemStatus() {
            if (!jwtToken) {
                addLog('JWT 토큰이 필요합니다.', 'error');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/v1/monitoring/alarms/status`, {
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const status = data.data;
                    addLog(`시스템 상태: SSE(${status.sse.enabled ? '활성' : '비활성'}), RabbitMQ(${status.rabbitmq.enabled ? '활성' : '비활성'})`, 'success');
                    addLog(`활성 SSE 연결: ${status.sse.activeConnections}개`);
                } else {
                    addLog(`상태 확인 실패: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`상태 확인 오류: ${error.message}`, 'error');
            }
        }

        // 로그 지우기
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // 페이지 로드 시 초기화
        window.onload = function() {
            addLog('DDOBANG 하이브리드 알림 시스템 테스트 페이지 로드됨');
        };

        // 페이지 언로드 시 연결 해제
        window.onbeforeunload = function() {
            disconnectSSE();
        };
    </script>
</body>
</html>