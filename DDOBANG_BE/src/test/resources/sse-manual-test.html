<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDOBANG SSE + RabbitMQ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; }
        .connected { color: green; }
        .error { color: red; }
        .message { color: blue; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ DDOBANG í•˜ì´ë¸Œë¦¬ë“œ ì•Œë¦¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
        
        <!-- ì—°ê²° ìƒíƒœ -->
        <div class="section">
            <h3>ğŸ“¡ SSE ì—°ê²° ìƒíƒœ</h3>
            <p>ìƒíƒœ: <span id="connectionStatus">ì—°ê²° í•´ì œ</span></p>
            <button onclick="connectSSE()">SSE ì—°ê²°</button>
            <button onclick="disconnectSSE()">ì—°ê²° í•´ì œ</button>
        </div>

        <!-- JWT í† í° -->
        <div class="section">
            <h3>ğŸ” JWT ì¸ì¦</h3>
            <button onclick="getToken()">JWT í† í° ìƒì„±</button>
            <p>í† í°: <span id="tokenStatus">ì—†ìŒ</span></p>
        </div>

        <!-- ì•Œë¦¼ í…ŒìŠ¤íŠ¸ -->
        <div class="section">
            <h3>ğŸ”” ì•Œë¦¼ í…ŒìŠ¤íŠ¸</h3>
            <button onclick="createParty()">íŒŒí‹° ìƒì„± (ì•Œë¦¼ ë°œìƒ)</button>
            <button onclick="sendMessage()">ë©”ì‹œì§€ ì „ì†¡ (ì•Œë¦¼ ë°œìƒ)</button>
            <button onclick="checkSystemStatus()">ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸</button>
        </div>

        <!-- ë¡œê·¸ -->
        <div class="section">
            <h3>ğŸ“ ì‹¤ì‹œê°„ ë¡œê·¸</h3>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>

    <script>
        let eventSource = null;
        let jwtToken = null;
        const BASE_URL = 'http://localhost:8080';

        // ë¡œê·¸ ì¶”ê°€
        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'connected' : 'message';
            log.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        // JWT í† í° ìƒì„±
        async function getToken() {
            try {
                const response = await fetch(`${BASE_URL}/api/v1/test/auth/token`);
                const data = await response.json();
                
                if (data.success) {
                    jwtToken = data.data.accessToken;
                    document.getElementById('tokenStatus').textContent = 'ìƒì„±ë¨';
                    addLog('JWT í† í° ìƒì„± ì„±ê³µ', 'success');
                } else {
                    addLog('JWT í† í° ìƒì„± ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                addLog(`í† í° ìƒì„± ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // SSE ì—°ê²°
        function connectSSE() {
            if (!jwtToken) {
                addLog('JWT í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € í† í°ì„ ìƒì„±í•˜ì„¸ìš”.', 'error');
                return;
            }

            if (eventSource) {
                eventSource.close();
            }

            const url = `${BASE_URL}/api/v1/alarms/subscribe`;
            eventSource = new EventSource(url + `?token=${jwtToken}`);

            eventSource.onopen = function() {
                document.getElementById('connectionStatus').textContent = 'ì—°ê²°ë¨';
                document.getElementById('connectionStatus').className = 'connected';
                addLog('SSE ì—°ê²° ì„±ê³µ', 'success');
            };

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                addLog(`ì•Œë¦¼ ìˆ˜ì‹ : ${data.title} - ${data.content}`, 'message');
            };

            eventSource.onerror = function(event) {
                document.getElementById('connectionStatus').textContent = 'ì—°ê²° ì˜¤ë¥˜';
                document.getElementById('connectionStatus').className = 'error';
                addLog('SSE ì—°ê²° ì˜¤ë¥˜', 'error');
            };
        }

        // SSE ì—°ê²° í•´ì œ
        function disconnectSSE() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            document.getElementById('connectionStatus').textContent = 'ì—°ê²° í•´ì œ';
            document.getElementById('connectionStatus').className = '';
            addLog('SSE ì—°ê²° í•´ì œ');
        }

        // íŒŒí‹° ìƒì„± (ì•Œë¦¼ ë°œìƒ)
        async function createParty() {
            if (!jwtToken) {
                addLog('JWT í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            const partyData = {
                title: `í…ŒìŠ¤íŠ¸ íŒŒí‹° ${new Date().getTime()}`,
                content: 'í•˜ì´ë¸Œë¦¬ë“œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ìš© íŒŒí‹°',
                maxPeople: 4,
                scheduledAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                themeId: 1,
                storeId: 1
            };

            try {
                const response = await fetch(`${BASE_URL}/api/v1/parties`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(partyData)
                });

                if (response.ok) {
                    addLog('íŒŒí‹° ìƒì„± ì„±ê³µ - ì•Œë¦¼ ë°œìƒ ì˜ˆìƒ', 'success');
                } else {
                    addLog(`íŒŒí‹° ìƒì„± ì‹¤íŒ¨: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`íŒŒí‹° ìƒì„± ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ë©”ì‹œì§€ ì „ì†¡ (ì•Œë¦¼ ë°œìƒ)
        async function sendMessage() {
            if (!jwtToken) {
                addLog('JWT í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            const messageData = {
                content: `í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ${new Date().getTime()}`,
                receiverId: 1
            };

            try {
                const response = await fetch(`${BASE_URL}/api/v1/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messageData)
                });

                if (response.ok) {
                    addLog('ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ - ì•Œë¦¼ ë°œìƒ ì˜ˆìƒ', 'success');
                } else {
                    addLog(`ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
        async function checkSystemStatus() {
            if (!jwtToken) {
                addLog('JWT í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/v1/monitoring/alarms/status`, {
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const status = data.data;
                    addLog(`ì‹œìŠ¤í…œ ìƒíƒœ: SSE(${status.sse.enabled ? 'í™œì„±' : 'ë¹„í™œì„±'}), RabbitMQ(${status.rabbitmq.enabled ? 'í™œì„±' : 'ë¹„í™œì„±'})`, 'success');
                    addLog(`í™œì„± SSE ì—°ê²°: ${status.sse.activeConnections}ê°œ`);
                } else {
                    addLog(`ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`ìƒíƒœ í™•ì¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ë¡œê·¸ ì§€ìš°ê¸°
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            addLog('DDOBANG í•˜ì´ë¸Œë¦¬ë“œ ì•Œë¦¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨');
        };

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° í•´ì œ
        window.onbeforeunload = function() {
            disconnectSSE();
        };
    </script>
</body>
</html>